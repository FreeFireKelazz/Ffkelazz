name: Debug AssetStudio CLI

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup .NET 8
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # 3️⃣ Install dependencies
      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdiplus libgtk-3-0 unzip wget

      # 4️⃣ Extract AssetStudio.zip (pastikan file ini ada di repo)
      - name: Extract AssetStudio
        run: |
          unzip AssetStudio.zip -d AssetStudio
          ls -R AssetStudio | head -n 100

      # 5️⃣ Jalankan tes AssetStudio CLI
      - name: Run AssetStudio CLI Test
        run: |
          echo "=== Download APK Free Fire Advance ==="
          mkdir -p /tmp/fftest/out
          cd /tmp/fftest
          wget -O input.apk "https://freefiremobile-a.akamaihd.net/advance/package/FFadv_66.51.0_0929_ID_goffadv1.apk"
          unzip -q input.apk -d apk_unzipped

          echo "=== Folder Check ==="
          ls -la apk_unzipped/assets || true
          ls -la apk_unzipped/assets/bin || true
          ls -la apk_unzipped/assets/bin/Data || true

          echo "=== File Count ==="
          cat <<'PY' > count.py
from pathlib import Path
p = Path("apk_unzipped")
for cand in [p / "assets" / "bin" / "Data", p / "assets", p]:
    if cand.exists():
        print("CAND:", cand, "files:", sum(1 for _ in cand.rglob("*")))
PY
          python3 count.py

          echo "=== Build CABMap ==="
          dotnet ../AssetStudio/AssetStudio.CLI.dll apk_unzipped/assets /tmp/fftest/out \
            --map_op CABMap --map_name ff_cliCabMap --game Normal --silent || true

          echo "=== Extract Assets ==="
          dotnet ../AssetStudio/AssetStudio.CLI.dll apk_unzipped/assets /tmp/fftest/out \
            --map_op Load --map_name ff_cliCabMap --game Normal \
            --types Texture2D,Sprite,Mesh,AudioClip --group_assets ByType --silent || true

          echo "=== List Output Files ==="
          find /tmp/fftest/out -maxdepth 3 -type f -print | sed -n '1,200p'
