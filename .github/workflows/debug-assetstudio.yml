name: Debug AssetStudio CLI (AssetMap Fix)

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup .NET 8
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget libgdiplus python3

      # 4Ô∏è‚É£ Extract AssetStudio.zip
      - name: Extract AssetStudio
        run: |
          if [ ! -f "AssetStudio.zip" ]; then
            echo "‚ùå AssetStudio.zip tidak ditemukan di repo!"
            exit 1
          fi
          unzip -q AssetStudio.zip -d AssetStudio
          echo "‚úÖ AssetStudio.zip berhasil diekstrak!"
          ls -R AssetStudio | head -n 50

      # 5Ô∏è‚É£ Jalankan test extract di /tmp/fftest
      - name: Run AssetStudio CLI Test
        run: |
          echo "=== Buat folder kerja /tmp/fftest ==="
          mkdir -p /tmp/fftest/out
          cd /tmp/fftest

          echo "=== Download APK Free Fire Advance ==="
          echo "üì• Mulai download..."
          wget -q -O input.apk "https://freefiremobile-a.akamaihd.net/advance/package/FFadv_66.51.0_0929_ID_goffadv1.apk"
          RC=$?
          if [ $RC -ne 0 ]; then
            echo "‚ùå Gagal download APK!"
            exit 1
          fi

          echo "‚úÖ Download APK selesai ($(du -h input.apk | cut -f1))"
          unzip -q input.apk -d apk_unzipped

          echo "=== Folder Check ==="
          ls -la apk_unzipped/assets || true
          ls -la apk_unzipped/assets/bin || true
          ls -la apk_unzipped/assets/bin/Data || true

          echo "=== File Count ==="
          echo "from pathlib import Path" > count.py
          echo "p = Path('apk_unzipped')" >> count.py
          echo "for cand in [p / 'assets' / 'bin' / 'Data', p / 'assets', p]:" >> count.py
          echo "    if cand.exists():" >> count.py
          echo "        print('CAND:', cand, 'files:', sum(1 for _ in cand.rglob('*')))" >> count.py
          python3 count.py

          echo "=== Build AssetMap ==="
          dotnet "$GITHUB_WORKSPACE/AssetStudio/AssetStudio.CLI.dll" apk_unzipped/assets /tmp/fftest/out \
            --map_op AssetMap \
            --map_name ff_cliMap \
            --map_type XML \
            --game Normal --silent || true

          echo "=== Extract Assets ==="
          dotnet "$GITHUB_WORKSPACE/AssetStudio/AssetStudio.CLI.dll" apk_unzipped/assets /tmp/fftest/out \
            --map_op Load \
            --map_name ff_cliMap \
            --game Normal \
            --types Texture2D,Sprite,Mesh,AudioClip \
            --group_assets ByType --silent || true

          echo "=== List Output Files ==="
          find /tmp/fftest/out -maxdepth 3 -type f -print | sed -n '1,200p'

      # 6Ô∏è‚É£ CLI Help Info
      - name: CLI Help Info
        run: |
          echo "=== CLI HELP ==="
          dotnet AssetStudio/AssetStudio.CLI.dll --help || true
